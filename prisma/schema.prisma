// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

/// Core user and auth models
model User {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  email        String      @unique
  username     String?     @unique(map: "User_username_key")
  password     String
  role         UserRole
  status       UserStatus  @default(PENDING)
  firstName    String
  lastName     String
  bio          String?
  phone        String?     @unique
  profilePhoto String?
  school       String?
  grade        String?
  country      String?
  region       String?
  gradDate     DateTime?
  isVerified   Boolean     @default(false)
  lastLogin    DateTime?
  squadId      String?     @db.ObjectId
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  otps                   OTP[]
  refreshTokens          RefreshToken[]
  squadMembers           SquadMember[]
  teamMembers            TeamMember[]
  teamChats              TeamChat[]                @relation("UserTeamChats")
  teamJoinRequests       TeamJoinRequest[]         @relation("UserTeamJoinRequests")
  points                 Point[]
  userBadges             UserBadge[]
  leaderboards           Leaderboard[]
  notifications          Notification[]
  portfolio              Portfolio?
  squads                 Squad[]
  userProgresses         UserProgress[]
  scores                 Score[]
  mentorRequests         MentorRequest[]
  mentorAssignments      MentorAssignment[]
  reviewedDeliverables   TeamDeliverable[]         @relation("DeliverableReviewer")
  learningProgress       UserLearningProgress[]    @relation("UserLearningProgress")
  moduleCompletions      ModuleCompletion[]        @relation("ModuleCompletions")
  
  @@index([username(sort: Desc)], map: "User_username_idx")
}

enum UserRole {
  STUDENT
  MENTOR
  JUDGE
  SQUAD_LEAD
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  PENDING
  SUSPENDED
  INACTIVE
}

model OTP {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  code      String
  expiresAt DateTime
  type      OTPType
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

enum OTPType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

model RefreshToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

/// Organizations
model Squad {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  schoolName String
  region     String
  area       String
  leadId     String      @db.ObjectId
  status     SquadStatus @default(PENDING)
  createdAt  DateTime    @default(now())

  lead         User          @relation(fields: [leadId], references: [id])
  members      SquadMember[]
  hackathons   Hackathon[]
  leaderboards Leaderboard[]
}

enum SquadStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

model SquadMember {
  id       String    @id @default(auto()) @map("_id") @db.ObjectId
  squadId  String    @db.ObjectId
  userId   String    @db.ObjectId
  role     SquadRole
  joinedAt DateTime  @default(now())

  squad Squad @relation(fields: [squadId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@unique([squadId, userId])
}

enum SquadRole {
  STUDENT
  SQUAD_LEAD
}

/// Teams & Collaboration
model Team {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  school       String
  profileImage String?
  projectTitle String?
  description  String?
  createdAt    DateTime @default(now())

  members           TeamMember[]
  chats             TeamChat[]
  joinRequests      TeamJoinRequest[]
  submissions       Submission[]
  mentorRequests    MentorRequest[]
  mentorAssignments MentorAssignment[]
  mentorSessions    MentorSession[]
  leaderboards      Leaderboard[]
  deliverables      TeamDeliverable[]
}

model TeamMember {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  teamId   String   @db.ObjectId
  userId   String   @db.ObjectId
  role     TeamRole
  joinedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
}

enum TeamRole {
  MEMBER
  LEAD
}

model TeamChat {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  teamId      String   @db.ObjectId
  senderId    String   @db.ObjectId
  message     String
  attachments String[]
  createdAt   DateTime @default(now())

  team      Team           @relation(fields: [teamId], references: [id])
  sender    User           @relation("UserTeamChats", fields: [senderId], references: [id])
  readBy    TeamChatRead[]
}

model TeamChatRead {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  chatId    String   @db.ObjectId
  userId    String   @db.ObjectId
  readAt    DateTime @default(now())

  chat      TeamChat @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@index([userId, readAt])
}

model TeamJoinRequest {
  id        String                 @id @default(auto()) @map("_id") @db.ObjectId
  teamId    String                 @db.ObjectId
  userId    String                 @db.ObjectId
  message   String?
  status    TeamJoinRequestStatus  @default(PENDING)
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  team Team @relation(fields: [teamId], references: [id])
  user User @relation("UserTeamJoinRequests", fields: [userId], references: [id])

  @@unique([teamId, userId])
}

enum TeamJoinRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

/// Learning Path
model Stage {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  order          Int
  unlockCriteria String?
  description    String?

  resources Resource[]
  quizzes   Quiz[]
  progress  UserProgress[]

  @@unique([order])
}

model Resource {
  id       String       @id @default(auto()) @map("_id") @db.ObjectId
  stageId  String       @db.ObjectId
  title    String
  type     ResourceType
  url      String
  duration Int?
  order    Int

  stage Stage @relation(fields: [stageId], references: [id])

  @@unique([stageId, order])
}

enum ResourceType {
  VIDEO
  DOCUMENT
  QUIZ
  ASSIGNMENT
}

model Quiz {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  stageId      String @db.ObjectId
  title        String
  passingScore Int

  stage     Stage          @relation(fields: [stageId], references: [id])
  questions QuizQuestion[]
}

model QuizQuestion {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  quizId        String   @db.ObjectId
  question      String
  options       String[]
  correctAnswer String
  points        Int      @default(1)

  quiz Quiz @relation(fields: [quizId], references: [id])
}

model UserProgress {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  userId      String         @db.ObjectId
  stageId     String         @db.ObjectId
  status      ProgressStatus
  score       Int?
  completedAt DateTime?

  user  User  @relation(fields: [userId], references: [id])
  stage Stage @relation(fields: [stageId], references: [id])

  @@unique([userId, stageId])
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

/// Hackathons
model Hackathon {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  level     HackathonLevel
  squadId   String?         @db.ObjectId
  startDate DateTime
  endDate   DateTime
  status    HackathonStatus @default(UPCOMING)

  squad                Squad?                @relation(fields: [squadId], references: [id])
  submissions          Submission[]
  deliverableTemplates DeliverableTemplate[]
}

enum HackathonLevel {
  SCHOOL
  AREA
  REGIONAL
  NATIONAL
}

enum HackathonStatus {
  UPCOMING
  ONGOING
  COMPLETED
}

model Submission {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  hackathonId String   @db.ObjectId
  teamId      String   @db.ObjectId
  title       String
  description String
  fileUrls    String[]
  submittedAt DateTime @default(now())

  hackathon Hackathon @relation(fields: [hackathonId], references: [id])
  team      Team      @relation(fields: [teamId], references: [id])
  scores    Score[]
}

model Score {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  submissionId String  @db.ObjectId
  judgeId      String  @db.ObjectId
  criteria     String
  score        Int
  feedback     String?

  submission Submission @relation(fields: [submissionId], references: [id])
  judge      User       @relation(fields: [judgeId], references: [id])
}

/// Mentorship
model MentorRequest {
  id        String              @id @default(auto()) @map("_id") @db.ObjectId
  teamId    String              @db.ObjectId
  mentorId  String?             @db.ObjectId
  status    MentorRequestStatus @default(PENDING)
  priority  Int                 @default(0)
  message   String?
  createdAt DateTime            @default(now())

  team   Team  @relation(fields: [teamId], references: [id])
  mentor User? @relation(fields: [mentorId], references: [id])
}

enum MentorRequestStatus {
  PENDING
  ASSIGNED
  REJECTED
}

model MentorAssignment {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  mentorId  String    @db.ObjectId
  teamId    String    @db.ObjectId
  startDate DateTime
  endDate   DateTime?

  mentor   User            @relation(fields: [mentorId], references: [id])
  team     Team            @relation(fields: [teamId], references: [id])
  sessions MentorSession[]

  @@unique([mentorId, teamId])
}

model MentorSession {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId String   @db.ObjectId
  date         DateTime
  duration     Int
  notes        String?

  assignment MentorAssignment @relation(fields: [assignmentId], references: [id])
  team       Team?            @relation(fields: [teamId], references: [id])
  teamId     String?          @db.ObjectId
}

/// Gamification
model Point {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  amount    Int
  reason    String
  activity  String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model UserActivity {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  userId        String       @db.ObjectId
  type          ActivityType
  action        String
  metadata      Json?
  pointsAwarded Int          @default(0)
  createdAt     DateTime     @default(now())

  @@index([userId, createdAt])
  @@index([type, createdAt])
}

enum ActivityType {
  AUTH
  LEARNING
  HACKATHON
  MENTORSHIP
  COLLABORATION
  GAMIFICATION
}

model Badge {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String  @unique
  description String
  imageUrl    String?
  criteria    String?

  userBadges UserBadge[]
}

model UserBadge {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  userId   String   @db.ObjectId
  badgeId  String   @db.ObjectId
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  badge Badge @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
}

model Leaderboard {
  id      String  @id @default(auto()) @map("_id") @db.ObjectId
  userId  String? @db.ObjectId
  teamId  String? @db.ObjectId
  squadId String? @db.ObjectId
  points  Int
  rank    Int
  period  String

  user  User?  @relation(fields: [userId], references: [id])
  team  Team?  @relation(fields: [teamId], references: [id])
  squad Squad? @relation(fields: [squadId], references: [id])
}

/// Notifications
model Notification {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  userId    String           @db.ObjectId
  type      NotificationType
  title     String
  message   String
  data      Json?            // Additional metadata
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  expiresAt DateTime?        // Auto-delete after this time

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([expiresAt])
}

enum NotificationType {
  // Team notifications
  TEAM_INVITE
  TEAM_MEMBER_ADDED
  TEAM_MEMBER_REMOVED
  TEAM_ROLE_UPDATED
  TEAM_MESSAGE
  TEAM_JOIN_REQUEST
  TEAM_JOIN_APPROVED
  TEAM_JOIN_REJECTED
  
  // Points & Gamification
  POINTS_EARNED
  POINTS_MILESTONE
  BADGE_EARNED
  LEADERBOARD_UPDATE
  
  // Learning
  STAGE_UNLOCKED
  STAGE_COMPLETED
  QUIZ_PASSED
  COURSE_COMPLETED
  
  // Hackathon
  HACKATHON_UPCOMING
  HACKATHON_STARTED
  HACKATHON_REMINDER
  HACKATHON_SUBMISSION
  HACKATHON_RESULT
  
  // Mentorship
  MENTOR_ASSIGNED
  MENTOR_REQUEST
  MENTOR_SESSION_SCHEDULED
  
  // System
  SYSTEM_ANNOUNCEMENT
  SYSTEM_UPDATE
}

/// Portfolio
model Portfolio {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @unique @db.ObjectId
  bio             String?
  skills          String[]
  achievements    String[]
  certificateUrls String[]
  generatedAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

/// Default Data
model DefaultSchool {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  region    String?
  country   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DefaultRegion {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String   @unique
  country   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Team Deliverables
enum DeliverableType {
  PROPOSAL
  PROTOTYPE
  FINAL_SUBMISSION
  DOCUMENTATION
}

enum DeliverableStatus {
  PENDING
  APPROVED
  REJECTED
}

model DeliverableTemplate {
  id          String           @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  type        DeliverableType
  hackathonId String?          @db.ObjectId
  dueDate     DateTime
  required    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  hackathon    Hackathon?       @relation(fields: [hackathonId], references: [id], onDelete: SetNull)
  deliverables TeamDeliverable[]
  
  @@map("deliverable_templates")
}

model TeamDeliverable {
  id           String             @id @default(auto()) @map("_id") @db.ObjectId
  teamId       String             @db.ObjectId
  templateId   String             @db.ObjectId
  type         DeliverableType
  fileUrl      String
  description  String?
  status       DeliverableStatus  @default(PENDING)
  feedback     String?
  submittedAt  DateTime           @default(now())
  reviewedAt   DateTime?
  reviewedBy   String?            @db.ObjectId
  
  team         Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  template     DeliverableTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  reviewer     User?              @relation("DeliverableReviewer", fields: [reviewedBy], references: [id])
  
  @@map("team_deliverables")
}

/// Learning Paths
enum LearningPathAudience {
  STUDENTS
  MENTORS
  EVERYONE
}

model LearningPath {
  id          String                @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  audience    LearningPathAudience
  isCore      Boolean               @default(false)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  
  modules     LearningModule[]
  progress    UserLearningProgress[]
  
  @@map("learning_paths")
}

model LearningModule {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  pathId        String         @db.ObjectId
  title         String
  content       String         // JSON string from novel.sh editor
  order         Int
  quiz          Json?          // Array of quiz questions
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  path          LearningPath   @relation(fields: [pathId], references: [id], onDelete: Cascade)
  completions   ModuleCompletion[]
  
  @@unique([pathId, order])
  @@map("learning_modules")
}

model UserLearningProgress {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  userId          String       @db.ObjectId
  pathId          String       @db.ObjectId
  completedModules Int         @default(0)
  totalModules    Int
  progress        Float        @default(0) // Percentage
  startedAt       DateTime     @default(now())
  completedAt     DateTime?
  
  user            User         @relation("UserLearningProgress", fields: [userId], references: [id], onDelete: Cascade)
  path            LearningPath @relation(fields: [pathId], references: [id], onDelete: Cascade)
  
  @@unique([userId, pathId])
  @@map("user_learning_progress")
}

model ModuleCompletion {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  userId      String         @db.ObjectId
  moduleId    String         @db.ObjectId
  quizScore   Float?         // Percentage score on quiz
  completedAt DateTime       @default(now())
  
  user        User           @relation("ModuleCompletions", fields: [userId], references: [id], onDelete: Cascade)
  module      LearningModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  @@unique([userId, moduleId])
  @@map("module_completions")
}
